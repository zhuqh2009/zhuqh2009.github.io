---
layout:     post
title:      便捷的Centos上自用vpn搭建-pptp
category: blog
description: 快速搭建一个自用的可以访问外网的vpn服务
---


### 1、国外的VPS(Virtual Private Server )有哪些呢？

  VPS有很多，作者用的是<a href='https://www.vultr.com/?ref=7248298'>vultr</a>，因为其可以用alipay，太方便了,作者使用时，价格$2.5/月，比很多加速器vpn都便宜不少吧。

  傻瓜式注册一个VPS,然后支付一点，就可以部署一个自己的VPS实例。可以SSH登录去操作。
### 2、 centos7上搭建VPN（PPTP）
	
  2.1 检测PPP是否开启：
```
      sh> cat /dev/ppp
      cat: /dev/ppp: No such file or directory就没问题。
   ```
  2.2 安装iptables、ppp、pptpd
     sh> yum install ppp iptables pptpd
  2.3 编辑pptpd.conf
```
     sh> vi /etc/pptpd.conf
		localip  192.168.0.1
		remoteip 192.168.0.234-238,192.168.0.245
     //开启如上两项即可，形成一个虚拟LAN, 网关就是VPS主机（192.168.0.1）,连接的用户可以动态分配网段剩余的地址集。
  ```
  2.4 编辑options.pptpd
```
  sh> vi /etc/ppp/options.pptpd
  	 ms-dns 8.8.8.8
	 ms-dns 8.8.4.4
   //文件里去掉#注释,DNS配置成google的如上两个即可。
```
  2.5 创建VPN用户账号（可多个）
```
	sh> vi /etc/ppp/chap-secrets
    # Secrets for authentication using CHAP
	# client        server  secret                  IP addresses
	username1 pptpd password1 *
    //ip为*，表示不限制接入IP
```
  2.6 修改内核参数,开启包转发
```
	sh> vi /etc/sysctl.conf
	net.ipv4.ip_forward=1
	sh> sysctl -p
    //sysctl -p 命令是生效转发配置
```
   2.7 iptables设置
   sh> vi /etc/sysconfig/iptables
我的整个iptables设置如下：
```
*nat
:PREROUTING ACCEPT [1:44]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [2:146]
:POSTROUTING ACCEPT [2:146]
-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# Completed on Sat Oct 28 09:23:29 2017
# Generated by iptables-save v1.4.21 on Sat Oct 28 09:23:29 2017
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [215:25052]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p gre -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW,RELATED,ESTABLISHED -m tcp --dport 1723 -j ACCEPT
-A INPUT -p gre -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i ppp+ -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
-A OUTPUT -p gre -j ACCEPT
COMMIT

//其中的eth0需要替换成你的VPS的时间网卡，可以netstat 看到。
//肯定要开启的22 ssh端口，1723 vpn默认端口。还需要开启gre协议。
```
 2.8 启动pptp和iptables
```
重启iptables: sh> systemctl restart iptables.service
启动pptp: sh> systemctl start pptpd.service
重启pptp: sh> systemctl restart pptpd.service

其他命令：
pptp状态查看： sh> systemctl status pptpd.service
iptables状态查看： sh> systemctl status iptables.service
```


#### 备注

关闭默认的firewall
systemctl status firewalld.service #检测是否开启了firewall
 
systemctl stop firewalld.service #关闭firewall
 
sytsemctl disable firewalld.service #禁止firewall开机自启
安装 yum install iptables-services